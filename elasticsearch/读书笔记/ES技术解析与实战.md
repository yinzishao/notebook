# ES技术解析与实战

标签（空格分隔）： ES

---

## 2.6 状态管理

清除缓存接口可以清除所有缓存或者关联一个或更多索引的特定缓存:
`POST http://127.0.0.1:9200/secisland/_cache/clear`
接口默认清理所有缓存,可以明确设置query、fielddata和request来清理特定缓存。


冲洗（flush）接口可以通过接口冲洗一个或多个索引。索引主要通过执行冲洗将数据保存到索引存储并且清除内部事务日志,以此来释放索引的内存空间。默认的,Elasticscarch使用内存启发式算法来自动触发冲洗操作的请求来清理内存:
`PoST http://127.0.0.1:9200/secisland/_flush`

> ？内部是每5分钟进行事务日志的落地。但这里指的是段合并。5秒进行一次段合并或者段数超过一定的阈值后进行。

合并接口可以强制合并一个或更多索引。合并分片数量和每个分片保存的Lucene索引。强制合并可以通过合并来减少分片数量。
调用会被阻塞直到合并完成。如果 htp连接丢失,请求会在后台继续执行,任何新的请求都会被阻塞直到前一个强制合并完成。
`POST http://127.0.0.1:9200/secisland/_forcemerge`

> 区别

[indices-forcemerge](https://www.elastic.co/guide/en/elasticsearch/reference/5.5/indices-forcemerge.html): only_expunge_deletes参数

## 6.1 集群节点监控
活跃线程查看

通过 nodes/hot_threads接口查询活跃线程,在nodes后面加上节点名可以查询某个节点上的活跃线程。
请求:`GET htt:/127.0.0.1:9200/_nodes/hot_threads`
或者请求具体某个节点:`GET htp:/127.0.0.1:9200/_nodes/{nodeslds}/hot threads`.

在Elasticsearch中可以通过集群路由API `_cluster/reroute`来对集群中的分片进行操作, 例如可以在集群中把一个分片从一个节点迁移到另一个节点,将未分配的分片可以分配到一个特定节点上等。不过要想完全手动,必须先把`cluster.routing.allcation.disable.allcation` 参数设置为true,禁止 ES进行自动索引分片分配,否则你从A节点把分片移到B节点,那么另外一个节点的一个分片又会移到A节点。语法如下:
请求:POST htp:/127.0.0.1:9200cluster/reroute

节点有以下类型:
- 主（master）节点:在一个节点上当node.master设置为true(默认）的时候,它有资格被选作为主节点,控制整个集群。
- 数据（data）节点:在一个节点上node.data设置为true(默认）的时候。该节点保存数据和执行数据相关的操作,如增删改查、搜索和聚合。

默认情况下,节点同时是**主节点和数据节点**,这是非常方便的小集群,但随着集群的发展,**分离主节点和数据节点**将变得非常重要。

- 客户端节点:当一个节点的nodc.master和node.data都设置为false的时候,它**既不能保持数据也不能成为主节点,该节点可以作为客户端节点**,可以**响应用户的请求, 并把相关操作发送到其他节点**。

- 部落节点:当一个节点配置tribe.*的时候,它是一个特殊的客户端,它可以**连接多个集群,在所有连接的集群上执行搜索和其他操作**。

客户端节点在搜索请求或批量增加索引请求等可能涉及在不同数据节点上的操作。这些请求会分成两个阶段,**一是接收客户端的请求,二是协调节点执行相关操作**。当数据分散在不同的节点上时,协调节点将请求转发到数据节点,每个数据节点在本地执行请求并把结果传输给协调节点,然后协调节点收集各个数据节点的结果转换成单个请求结果返回。所以需要客户端有**足够的内存和CPU来处理各个节点的返回结果**。

> 客户端节点跟协调节点的关系？它既不是主节点也不是客户端节点

## 6.3 集群节点配置

主节点的主要职责是和集群操作相关的内容,如**创建或删除索引,跟踪哪些节点是集群的一部分,并决定哪些分片分配给相关的节点**。**稳定**的主节点对集群的健康是非常重要的。默认情况下**任何一个**集群中的节点都**有可能**被选为主节点。

**索引数据和搜索查询**等操作会占用**大量的CPU、内存、IO资源**,为了确保一个集群的稳定,**分离主节点和数据节点**是一个比较好的选择。虽然主节点**也可以协调节点**,搜索路由和从客户端新增数据到数据节点,但最好不要使用这些专用的主节点。一个重要的原则是,**尽可能做少量的工作**。创建一个独立的主节点的配置如下`node.master:true`, `node.data: false`


为了防止数据丢失,配置`discovery.zen.minimum.master.nodes`是至关重要的（默认为1）,每个主节点应该知道形成一个集群的**最小数量的主资格节点的数量**。解释一下。假设我们有一个集群,有3个主节点,当网络发生故障的时候,有可能其中一个节点不能和其他节点进行通信了。这个时候,当 discovery.zen.minimum_master nodes设置为1时, 就会**分成两个小的独立集群**,当网络好的时候,就会出现**数据错误或者丢失数据的情况**。

当`discovery.zen.minimum.master.nodes`设置为2的时候,一个网络中有两个主节点,可以继续工作,另一部分,由于只有一个主资格节点,则不会形成一个独立的集群,这个时候当网络回复的时候,节点又会重新加入集群。设置这个值的原则是:`(maater_eligible_nodes/2)+1`。这个参数也可以动态设置:请求:
```
PUT htp:/127.0.0.1:9200/_cluster/sttings
{"transient":("discovery.zen.minimum_master_nodes":2}
```

> 网络故障的时候的主节点集群的高可用、CP。一致性与可用性。TODO：主节点的共识算法是什么？

当主节点和数据节点配置都设置为false时,该节点**只能处理路由请求,处理搜索,分发索引操作等**,从本质上来说该客户端节点表现为**智能负载平衡器**。独立的客户端节点在一个**比较大的集群中**是非常有用的,它协调主节点和数据节点,客户端节点加入集群可以得到集群的状态,根据集群的状态可以**直接发送路由请求**。
> 上面也有说到：所以需要客户端有**足够的内存和CPU来处理各个节点的返回结果**。

注意：添加太多的客户端节点对集群是一种**负担**,因为主节点必须**等待每一个节点集群状态的更新确**认!客户端节点的作用不应被夸大,数据节点也可以起到类似的作用。

`elasticsearch--path.data /var/elasticsearch/data`

这个路径最好进行**单独配置**,这样Elasticsearch的目录和数据的目录就会分开。当删除了Elasticsearch主目录的时候,不会影响到数据。通过 rpm 安装默认是分开的。

**数据目录可以被多个节点共享,甚至可以属于不同的集群**,为了防止多个节点共享相同的数据路径,可以在配置文件elasticsearch.yml中添加:`node_max local_storage nodes:1`

注意： **在相同的数据目录不要运行不同类型的节点**（例如:master、data、client）,这会导致**意外的数据丢失**。

zen发现机制是默认的发现模块。它提供了单播发现方式，能够很容易地扩展至云环境。发现模块和其他模块集成，例如所有节点的通信是通过传输模块。发现模块分成两个模块∶

## 6.5 集群平衡配置

分片分配设置

## 8.5.2 索引碎片分配

2.延迟分配
延迟分配由于节点离开造成的未赋值碎片。当节点离开集群时，主要的反应是∶
- 提升副本分片为主分片来替换节点中的任何主分片。
- 分配副本分片替换缺失副本（假设有足够的节点）。
- 分片再平衡，均匀地分配到其余节点。
这些行为的目的是保护集群防止数据丢失，通过确保每个分片尽可能快地完全复制。

如果主节点只等了几分钟，然后缺失分片可以使用最小的网络流量重新分配给节点5。这个过程对于被动态同步刷新的空分片会更快速。

副本分片的分配可以通过动态设置`index.unassigned.node_left.delayed_timeout`延迟，默认为1m。

（1）取消分片移动

如果延时分配超时，主节点会开始恢复缺失分片到另一个节点。

如果缺失节点重新加入集群中，并且它的主分片仍然有相同的同步ID，分片移动会被取消并且同步分片会用于恢复。

由于这个原因，默认的timeout设置为一分钟∶即使分片开始移动，取消恢复同步分片的花销也是小的。

> 怎么取消分片移动。具体场景和例子？

### 8.5.7 事务日志

Lucene的修改只有在提交的时候保存在磁盘上，这是个相对沉重的操作，所以不能在每次索引或删除操作之后执行。一次提交之后另一次提交之前如果发生了进程退出或硬件故障的事件，这之间的修改会丢失。

为了防止数据丢失，每个分片都有事务日志（translog）或与之相关的日志。任何索引或删除操作在Lucene索引内部执行之后会被写入事务日志。

如果发生了崩溃事件，当分片恢复的时候，最近的事务可以根据事务日志进行恢复。Elasticsearch冲洗（flush）操作是执行Lucene提交并开始新的事务日志的过程。会自动进行后台执行来确保事务日志不会变得太大，这会使重做操作在恢复时花费大量的时间。可以通过接口调用，虽然很少需要手动执行。

事务日志的数据仅在事务同步和提交之后保存在磁盘上。如果发生了硬件错误，前一次事务日志提交之后的任何数据写入都会丢失。

默认情况下，Elasticsearch在任何索引、删除、更新或大量请求之后会提交事务日志。事实上，在事务日志被成功地同步和提交给主分片和任何分配的副本分片之后，Elasticsearch 只会报告成功执行的请求给客户。

> 阅读：这本书有点老了，只看了索引、分片相关的章节。分片的移动等章节，感觉只讲了一些配置项的作用，并没有深入讲述。8.5索引配置较贴切工作，第6章的集群管理也较简单、浅尝辄止，也可以阅读熟悉相关配置选项。

> 笔记：事务日志;分片分配、移动策略;节点类型和职责;
